#!/bin/bash
#
# Builds the LiteRT-LM C API as a shared library (.so / .dylib)
#
# Uses Bazel to compile from source. Run this ONCE.
# Output goes to prebuilt/<platform>/.
#
# Supports: Linux (x86_64, arm64), macOS (arm64)
#
# Prerequisites: bazelisk/bazel, clang, python3, git
#
# Usage:
#   ./build_unix.sh [/path/to/LiteRT-LM]

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"
LITERT_LM_DIR="${1:-}"

echo ""
echo "============================================"
echo "  LiteRT-LM C API Shared Library Builder"
echo "============================================"
echo ""

# ============================================================================
# Resolve LiteRT-LM source
# ============================================================================

if [ -z "$LITERT_LM_DIR" ]; then
    for candidate in \
        "$REPO_ROOT/../LiteRT-LM-ref" \
        "$REPO_ROOT/../LiteRT-LM" \
        "$HOME/LiteRT-LM"; do
        if [ -f "$candidate/c/engine.h" ]; then
            LITERT_LM_DIR="$(cd "$candidate" && pwd)"
            break
        fi
    done
fi

if [ -z "$LITERT_LM_DIR" ] || [ ! -f "$LITERT_LM_DIR/c/engine.h" ]; then
    echo "ERROR: LiteRT-LM source not found." >&2
    echo "Pass path as argument or clone next to this repo:" >&2
    echo "  git clone https://github.com/google-ai-edge/LiteRT-LM.git ../LiteRT-LM" >&2
    exit 1
fi

# Detect platform
OS=$(uname -s)
ARCH=$(uname -m)

case "$OS" in
    Darwin)
        if [ "$ARCH" = "arm64" ]; then
            NATIVE_ARCH="macos_arm64"
            LIB_EXT="dylib"
        else
            echo "ERROR: Only arm64 (Apple Silicon) is supported for macOS" >&2; exit 1
        fi
        ;;
    Linux)
        LIB_EXT="so"
        case "$ARCH" in
            x86_64)  NATIVE_ARCH="linux_x86_64" ;;
            aarch64) NATIVE_ARCH="linux_arm64" ;;
            *)       echo "ERROR: Unsupported arch: $ARCH" >&2; exit 1 ;;
        esac
        ;;
    *)
        echo "ERROR: Unsupported OS: $OS (use build_windows.ps1 for Windows)" >&2; exit 1
        ;;
esac

OUTPUT_DIR="$REPO_ROOT/prebuilt/$NATIVE_ARCH"
mkdir -p "$OUTPUT_DIR"

echo "LiteRT-LM source: $LITERT_LM_DIR"
echo "Platform:          $OS $ARCH ($NATIVE_ARCH)"
echo "Output dir:        $OUTPUT_DIR"
echo ""

# ============================================================================
# Verify tools
# ============================================================================

echo "Checking build tools..."

BAZEL=""
for cmd in bazelisk bazel; do
    if command -v "$cmd" &>/dev/null; then
        BAZEL="$cmd"
        echo "  Bazel: $(command -v $cmd)"
        break
    fi
done
if [ -z "$BAZEL" ]; then
    echo "ERROR: bazelisk or bazel not found in PATH" >&2
    echo "  Install: npm install -g @bazel/bazelisk" >&2
    exit 1
fi
echo ""

# ============================================================================
# Create temporary shared library target
# ============================================================================

echo "Setting up build target..."

BUILD_FILE="$LITERT_LM_DIR/c/BUILD"
STUB_FILE="$LITERT_LM_DIR/c/capi_dll_entry.cc"
BUILD_BACKUP="$BUILD_FILE.litert_lm_ffi_backup"

cp "$BUILD_FILE" "$BUILD_BACKUP"

cat > "$STUB_FILE" << 'EOF'
// LiteRT-LM C API shared library entry point.
// All C API symbols are exported from engine.cc.
// This stub exists only because Bazel cc_binary requires at least one source.
EOF

cat >> "$BUILD_FILE" << 'EOF'

# ======================================================================
# LiteRT-LM-FFI: Shared library target
# (auto-generated by build_unix.sh - DO NOT COMMIT to LiteRT-LM)
# ======================================================================
cc_binary(
    name = "litert_lm_capi",
    srcs = ["capi_dll_entry.cc"],
    linkshared = True,
    deps = [":engine"],
    visibility = ["//visibility:public"],
)
EOF

echo "  Created cc_binary(linkshared=True) target: //c:litert_lm_capi"
echo ""

# ============================================================================
# Cleanup on exit
# ============================================================================

cleanup() {
    echo ""
    echo "Cleaning up temporary build files..."
    if [ -f "$BUILD_BACKUP" ]; then
        cp "$BUILD_BACKUP" "$BUILD_FILE"
        rm -f "$BUILD_BACKUP"
        echo "  Restored original c/BUILD"
    fi
    if [ -f "$STUB_FILE" ]; then
        rm -f "$STUB_FILE"
        echo "  Removed capi_dll_entry.cc"
    fi
}
trap cleanup EXIT

# ============================================================================
# Build
# ============================================================================

echo "Building LiteRT-LM C API shared library..."
echo "  First build downloads deps + compiles everything (~5-15 min)"
echo "  Subsequent builds are near-instant (Bazel caches everything)"
echo ""

cd "$LITERT_LM_DIR"

$BAZEL build //c:litert_lm_capi

echo ""
echo "Build succeeded!"

# ============================================================================
# Copy output
# ============================================================================

echo ""
echo "Copying build output..."

LIB_PATH=""
for candidate in \
    "$LITERT_LM_DIR/bazel-bin/c/litert_lm_capi.$LIB_EXT" \
    "$LITERT_LM_DIR/bazel-bin/c/liblitert_lm_capi.$LIB_EXT" \
    "$LITERT_LM_DIR/bazel-bin/c/litert_lm_capi"; do
    if [ -f "$candidate" ]; then
        LIB_PATH="$candidate"
        break
    fi
done

if [ -n "$LIB_PATH" ]; then
    if [ "$OS" = "Darwin" ]; then
        OUT_NAME="liblitert_lm_capi.dylib"
    else
        OUT_NAME="liblitert_lm_capi.so"
    fi

    cp "$LIB_PATH" "$OUTPUT_DIR/$OUT_NAME"
    size=$(du -h "$OUTPUT_DIR/$OUT_NAME" | cut -f1)
    echo "  $OUT_NAME ($size)"

    if [ "$OS" = "Darwin" ]; then
        codesign --force --sign - "$OUTPUT_DIR/$OUT_NAME" 2>/dev/null || true
        echo "  Signed: $OUT_NAME"
    fi
else
    echo "  WARNING: Shared library not found in bazel-bin/c/" >&2
    ls -la "$LITERT_LM_DIR/bazel-bin/c/" 2>/dev/null || true
fi

# Copy prebuilt accelerator libraries
PREBUILT_DIR="$LITERT_LM_DIR/prebuilt/$NATIVE_ARCH"
if [ -d "$PREBUILT_DIR" ]; then
    for lib in "$PREBUILT_DIR"/*.$LIB_EXT "$PREBUILT_DIR"/*.so; do
        [ -f "$lib" ] || continue
        filename=$(basename "$lib")
        cp "$lib" "$OUTPUT_DIR/$filename"
        echo "  $filename (accelerator)"
        if [ "$OS" = "Darwin" ]; then
            codesign --force --sign - "$OUTPUT_DIR/$filename" 2>/dev/null || true
        fi
    done
fi

# ============================================================================
# Summary
# ============================================================================

echo ""
echo "============================================"
echo "  Build complete!"
echo "============================================"
echo ""
echo "Output: $OUTPUT_DIR"
for f in "$OUTPUT_DIR"/*; do
    [ -f "$f" ] || continue
    size=$(du -h "$f" | cut -f1)
    echo "  $(basename "$f") ($size)"
done
echo ""
echo "Load the shared library from your app via FFI (Dart, Python, Rust, Go, C#, etc.)"
echo "See include/engine.h for the full C API reference."
